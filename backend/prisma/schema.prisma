// ==================== NEURALLEMPIRE MULTI-COMPANY SCHEMA ====================
// Version 3.0 - Enterprise Multi-Company Accounting SaaS Architecture
// Complete schema with RBAC, Multi-Company Support, Dynamic Menus & Accounting Module
// Created: 2025-10-03
// Author: System Architect AI

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== PLATFORM ADMINISTRATION ====================

model PlatformAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         AdminRole @default(SUPPORT)
  permissions  Json      @default("[]") // Array of permission IDs

  // Security
  mfaEnabled   Boolean   @default(true)
  mfaSecret    String?
  lastLoginAt  DateTime?
  lastLoginIp  String?

  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  auditLogs    AuditLog[]
  adminActions AdminAction[]

  @@map("platform_admins")
}

model AdminAction {
  id          String    @id @default(cuid())
  adminId     String
  action      String    // e.g., "DEACTIVATE_ORG", "MODIFY_SUBSCRIPTION"
  targetType  String    // "ORGANIZATION", "USER", "AGENT", "COMPANY"
  targetId    String
  reason      String?
  metadata    Json?     // Additional action details

  admin       PlatformAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([targetType, targetId])
  @@index([adminId])
  @@index([createdAt])
  @@map("admin_actions")
}

// ==================== ORGANIZATION MANAGEMENT ====================

model Organization {
  id               String       @id @default(cuid())
  name             String
  slug             String       @unique
  domain           String?      @unique
  logo             String?
  description      String?
  industry         String?
  size             String?

  // Status Management
  status           OrgStatus    @default(TRIAL)
  statusReason     String?
  statusChangedAt  DateTime     @default(now())
  statusChangedBy  String?

  // Subdomain Management
  subdomainEnabled Boolean      @default(true)
  subdomainStatus  SubdomainStatus @default(PENDING)
  subdomainVerifiedAt DateTime?
  customDomain     String?      @unique
  customDomainVerified Boolean  @default(false)
  sslCertificateStatus SSLStatus @default(PENDING)
  sslCertificateExpiry DateTime?

  // Subscription & Billing
  planType         PlanType     @default(TRIAL)
  billingCycle     BillingCycle @default(MONTHLY)
  subscriptionId   String?      @unique
  billingEmail     String?

  // Trial Management
  trialEndsAt      DateTime?
  trialExtended    Boolean      @default(false)

  // Resource Limits (Plan-based)
  maxUsers         Int          @default(5)
  maxCompanies     Int          @default(1)    // NEW: Multi-company limit
  maxAgents        Int          @default(10)
  maxWorkflows     Int          @default(20)
  maxApiCalls      Int          @default(10000)
  storageLimit     BigInt       @default(5368709120) // 5GB

  // Usage Tracking
  currentUsers     Int          @default(0)
  currentCompanies Int          @default(0)    // NEW
  currentAgents    Int          @default(0)
  currentWorkflows Int          @default(0)
  apiCallsThisMonth Int         @default(0)
  storageUsed      BigInt       @default(0)

  // Security & SSO
  ssoEnabled       Boolean      @default(false)
  ssoProvider      SSOProvider?
  ssoConfig        Json?
  samlMetadata     String?
  allowedDomains   String[]     @default([])

  // Compliance
  dataRetention    Int          @default(90) // days
  ipWhitelist      String[]     @default([])

  // Onboarding
  onboardingCompleted Boolean   @default(false)
  onboardingStep   Int          @default(0)
  setupWizardCompleted Boolean  @default(false)
  firstAgentCreated Boolean     @default(false)

  // Metadata
  verifiedAt       DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  deletedAt        DateTime?

  // Relations
  users            User[]
  companies        Company[]                   // NEW: Multi-company support
  roles            Role[]                      // NEW: RBAC
  agents           Agent[]
  workflows        AgentWorkflow[]
  workflowTemplates WorkflowTemplate[]
  interactions     AgentInteraction[]
  subscriptions    Subscription[]
  invoices         Invoice[]
  apiKeys          ApiKey[]
  webhooks         Webhook[]
  auditLogs        AuditLog[]
  agentTemplates   AgentTemplate[]
  usageMetrics     UsageMetric[]
  notifications    Notification[]
  subdomainRecords SubdomainRecord[]
  oauthConfigs     OAuthConfig[]
  socialAccounts   SocialAccount[]
  agentSwarms      AgentSwarm[]
  payments         Payment[]

  @@index([status])
  @@index([planType])
  @@index([slug])
  @@index([subdomainStatus])
  @@map("organizations")
}

// ==================== ðŸš€ NEW: MULTI-COMPANY SUPPORT ====================

model Company {
  id              String   @id @default(cuid())
  organizationId  String

  // Company Details
  companyCode     String   // Unique within organization (e.g., "ACME001")
  name            String
  legalName       String?
  taxId           String?
  registrationNumber String?

  // Accounting Settings
  currencyCode    String   @default("USD")
  fiscalYearStart Int      @default(1) // Month (1-12)
  fiscalYearEnd   Int      @default(12)
  accountingMethod AccountingMethod @default(ACCRUAL)

  // Address
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  country         String   @default("US")
  zipCode         String?

  // Contact
  phone           String?
  email           String?
  website         String?

  // Settings
  settings        Json     @default("{}")
  preferences     Json     @default("{}")

  // Status
  status          CompanyStatus @default(ACTIVE)

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAccess      UserCompanyAccess[]  // NEW: Many-to-many with users
  accounts        Account[]            // Accounting: Chart of Accounts
  transactions    Transaction[]        // Accounting: Transactions
  customers       Customer[]           // Accounting: Customers
  vendors         Vendor[]             // Accounting: Vendors

  @@unique([organizationId, companyCode])
  @@index([organizationId])
  @@index([status])
  @@map("companies")
}

// ==================== ðŸš€ NEW: USER-COMPANY ACCESS (MANY-TO-MANY) ====================

model UserCompanyAccess {
  id              String   @id @default(cuid())
  userId          String
  companyId       String
  roleId          String?

  // Access Control
  permissions     Json     @default("[]") // Override permissions for this company
  isDefault       Boolean  @default(false) // Default company for user

  // Activity Tracking
  lastAccessedAt  DateTime?
  accessCount     Int      @default(0)

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role            Role?    @relation(fields: [roleId], references: [id], onDelete: SetNull)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@index([lastAccessedAt])
  @@map("user_company_access")
}

// ==================== ðŸš€ NEW: RBAC - ROLES & PERMISSIONS ====================

model Role {
  id              String   @id @default(cuid())
  organizationId  String

  // Role Details
  name            String
  code            String   // Unique code like "ACCOUNTANT", "MANAGER"
  description     String?
  isSystem        Boolean  @default(false) // System roles can't be deleted
  isDefault       Boolean  @default(false) // Default role for new users

  // Permissions
  permissions     Json     @default("[]") // Array of permission codes

  // Priority (for role hierarchy)
  priority        Int      @default(0)    // Higher = more permissions

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userAccess      UserCompanyAccess[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([isSystem])
  @@map("roles")
}

model Permission {
  id              String   @id @default(cuid())

  // Permission Structure (module:action:resource)
  module          String   // e.g., "accounting", "agents", "settings", "company"
  action          String   // e.g., "create", "read", "update", "delete", "approve"
  resource        String   // e.g., "transactions", "agents", "users", "reports"

  // Permission Code (unique identifier)
  code            String   @unique // e.g., "accounting:create:transactions"

  // Details
  description     String?
  isAdminOnly     Boolean  @default(false)
  category        String?  // Group permissions by category

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([module, action, resource])
  @@index([module])
  @@index([category])
  @@map("permissions")
}

// ==================== ðŸš€ NEW: DYNAMIC MENU SYSTEM ====================

model MenuItem {
  id              String   @id @default(cuid())
  parentId        String?

  // Menu Details
  name            String
  label           String   // Display label
  icon            String?  // Icon name/class
  route           String?  // Frontend route
  component       String?  // Component name

  // Permissions
  permissionsRequired Json @default("[]") // Array of permission codes required
  rolesRequired   Json     @default("[]") // Array of role codes required

  // Display
  orderIndex      Int      @default(0)
  isActive        Boolean  @default(true)
  showInSidebar   Boolean  @default(true)
  isSeparator     Boolean  @default(false)
  badge           String?  // Badge text (e.g., "New", "Beta")
  badgeColor      String?

  // Module/Category
  module          String?  // Which module this belongs to

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  parent          MenuItem? @relation("MenuHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        MenuItem[] @relation("MenuHierarchy")

  @@index([parentId])
  @@index([orderIndex])
  @@index([module])
  @@index([isActive])
  @@map("menu_items")
}

// ==================== ðŸš€ NEW: USER PREFERENCES ====================

model UserPreference {
  id              String   @id @default(cuid())
  userId          String   @unique

  // Defaults
  defaultCompanyId String?
  defaultDashboard String?  // Default dashboard view

  // UI Preferences
  theme           String   @default("light") // light, dark, auto
  language        String   @default("en")
  timezone        String   @default("UTC")
  dateFormat      String   @default("MM/DD/YYYY")
  timeFormat      String   @default("12h") // 12h, 24h
  numberFormat    String   @default("en-US")

  // Dashboard
  dashboardLayout Json?    // Custom dashboard layout
  widgets         Json?    // Enabled widgets

  // Notifications
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(true)
  notificationTypes  Json    @default("[]") // Which notification types to receive

  // Additional Preferences
  sidebarCollapsed Boolean  @default(false)
  tablePageSize    Int      @default(25)
  preferences      Json     @default("{}")

  // Metadata
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_preferences")
}

// ==================== USER & AUTH ====================

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  passwordHash   String?  // Optional for OAuth-only users
  firstName      String?
  lastName       String?
  avatar         String?
  phone          String?
  timezone       String   @default("UTC")

  // Organization & Role
  organizationId String
  role           UserRole @default(MEMBER) // Organization-level role
  department     String?
  title          String?

  // Legacy Permissions (deprecated, use RBAC instead)
  permissions    Json?
  canCreateAgents Boolean @default(true)
  canManageWorkflows Boolean @default(true)
  canViewAnalytics Boolean @default(true)

  // Super Admin (platform-wide access)
  isSuperAdmin   Boolean  @default(false) // NEW: Super admin flag

  // Status & Security
  status         UserStatus @default(PENDING)
  statusReason   String?
  emailVerified  Boolean    @default(false)
  phoneVerified  Boolean    @default(false)
  mfaEnabled     Boolean    @default(false)
  mfaSecret      String?

  // Activity
  lastLoginAt    DateTime?
  lastLoginIp    String?
  loginCount     Int       @default(0)
  lastLoginMethod LoginMethod?

  // Onboarding & Preferences
  onboardingStep Int       @default(0)
  onboardingCompleted Boolean @default(false)
  preferences    Json?
  locale         String    @default("en")

  // Security
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String?
  backupCodes    String[] @default([])

  // Metadata
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  deletedAt      DateTime?

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  companyAccess  UserCompanyAccess[]  // NEW: Multi-company access
  userPreference UserPreference?      // NEW: User preferences
  sessions       Session[]
  socialAccounts SocialAccount[]
  createdAgents  Agent[]      @relation("AgentCreator")
  ownedAgents    Agent[]      @relation("AgentOwner")
  workflows      AgentWorkflow[] @relation("WorkflowCreator")
  auditLogs      AuditLog[]
  notifications  Notification[]
  createdSwarms  AgentSwarm[]

  @@index([organizationId, status])
  @@index([email])
  @@index([lastLoginAt])
  @@index([isSuperAdmin])
  @@map("users")
}

// ==================== SUBDOMAIN MANAGEMENT ====================

model SubdomainRecord {
  id              String   @id @default(cuid())
  organizationId  String

  // DNS Configuration
  subdomain       String   @unique
  fullDomain      String   @unique
  recordType      String   @default("CNAME")
  recordValue     String

  // Status & Health
  status          SubdomainStatus @default(PENDING)
  isActive        Boolean  @default(true)

  // DNS Provider Info
  dnsProvider     String   @default("cloudflare")
  externalRecordId String?

  // SSL/TLS
  sslEnabled      Boolean  @default(true)
  sslProvider     String   @default("cloudflare")
  sslCertId       String?

  // Monitoring
  lastHealthCheck DateTime?
  healthStatus    HealthStatus @default(UNKNOWN)
  uptime          Float    @default(100.0)
  responseTime    Int?

  // Metadata
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([subdomain])
  @@index([status])
  @@index([organizationId])
  @@map("subdomain_records")
}

// ==================== OAUTH & SOCIAL ACCOUNTS ====================

model SocialAccount {
  id              String   @id @default(cuid())
  userId          String
  organizationId  String

  // Provider Info
  provider        OAuthProvider
  providerId      String
  providerEmail   String?
  providerUsername String?

  // OAuth Data
  accessToken     String?
  refreshToken    String?
  tokenType       String   @default("Bearer")
  expiresAt       DateTime?
  scope           String[] @default([])

  // Account Info
  displayName     String?
  profileUrl      String?
  avatarUrl       String?

  // Metadata from Provider
  providerData    Json?

  // Status
  isActive        Boolean  @default(true)
  isPrimary       Boolean  @default(false)
  lastUsedAt      DateTime?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId])
  @@unique([userId, provider])
  @@index([userId])
  @@index([provider])
  @@index([organizationId])
  @@map("social_accounts")
}

model OAuthConfig {
  id              String   @id @default(cuid())
  organizationId  String

  // Provider Configuration
  provider        OAuthProvider
  clientId        String
  clientSecret    String   // Encrypted

  // Configuration
  enabled         Boolean  @default(true)
  allowedDomains  String[] @default([])
  autoCreateUsers Boolean  @default(true)
  autoJoinOrg     Boolean  @default(false)
  defaultRole     UserRole @default(MEMBER)

  // Customization
  buttonText      String?
  buttonColor     String?
  logoUrl         String?

  // Advanced Settings
  scope           String[] @default([])
  additionalParams Json?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@map("oauth_configs")
}

// ==================== SESSION MANAGEMENT ====================

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique @default(cuid())

  // Session Details
  sessionType SessionType @default(WEB)
  loginMethod LoginMethod?

  // Company Context (NEW)
  companyId   String?  // Current active company for this session

  // Device & Location
  userAgent String?
  ipAddress String?
  device    String?
  browser   String?
  os        String?
  location  Json?

  // Subdomain Support
  subdomain String?
  originUrl String?

  // Security
  isActive  Boolean @default(true)
  isSuspicious Boolean @default(false)
  riskScore Float?

  // Session Management
  expiresAt DateTime
  lastAccessedAt DateTime @default(now())
  refreshedAt DateTime @default(now())

  // Metadata
  metadata  Json?
  createdAt DateTime @default(now())

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([companyId])
  @@index([subdomain])
  @@index([isActive])
  @@index([expiresAt])
  @@map("sessions")
}

// ==================== ACCOUNTING MODULE ====================

model Account {
  id              String   @id @default(cuid())
  companyId       String

  // Account Details
  accountCode     String   // e.g., "1000", "1100"
  accountName     String   // e.g., "Cash", "Accounts Receivable"
  accountType     AccountType
  accountSubType  String?  // e.g., "CurrentAsset", "FixedAsset"

  // Hierarchy
  parentAccountId String?
  level           Int      @default(0) // Tree depth level
  fullPath        String?  // e.g., "1000/1100/1110" for quick queries

  // Settings
  isSystemAccount Boolean  @default(false) // Cannot be deleted
  isActive        Boolean  @default(true)
  isContraAccount Boolean  @default(false) // Contra accounts (e.g., Accumulated Depreciation)
  normalBalance   NormalBalance @default(DEBIT) // DEBIT or CREDIT

  // Balance
  balance         Decimal  @default(0) @db.Decimal(15, 2)
  debitBalance    Decimal  @default(0) @db.Decimal(15, 2)
  creditBalance   Decimal  @default(0) @db.Decimal(15, 2)

  // Description
  description     String?
  notes           String?

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?

  // Relations
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  parent          Account? @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  children        Account[] @relation("AccountHierarchy")
  journalEntries  JournalEntry[]

  @@unique([companyId, accountCode])
  @@index([companyId])
  @@index([accountType])
  @@index([parentAccountId])
  @@index([isActive])
  @@map("accounts")
}

model Transaction {
  id              String   @id @default(cuid())
  companyId       String

  // Transaction Details
  transactionNumber String
  transactionDate DateTime
  postingDate     DateTime?    // When transaction was posted
  description     String?
  reference       String?  // External reference
  memo            String?

  // Transaction Type
  transactionType TransactionType @default(JOURNAL_ENTRY)

  // Status
  status          TransactionStatus @default(DRAFT)

  // Amounts
  totalDebit      Decimal  @default(0) @db.Decimal(15, 2)
  totalCredit     Decimal  @default(0) @db.Decimal(15, 2)

  // Related Entities
  customerId      String?
  vendorId        String?

  // Audit Trail
  createdBy       String
  approvedBy      String?
  approvedAt      DateTime?
  postedBy        String?
  postedAt        DateTime?

  // Reversal
  isReversed      Boolean  @default(false)
  reversedBy      String?
  reversedAt      DateTime?
  reversalOf      String?  // ID of transaction this reverses

  // Attachments
  attachments     Json?    // Array of file URLs

  // Metadata
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  journalEntries  JournalEntry[]
  customer        Customer? @relation(fields: [customerId], references: [id])
  vendor          Vendor?   @relation(fields: [vendorId], references: [id])

  @@unique([companyId, transactionNumber])
  @@index([companyId])
  @@index([transactionDate])
  @@index([status])
  @@index([customerId])
  @@index([vendorId])
  @@map("transactions")
}

model JournalEntry {
  id              String   @id @default(cuid())
  transactionId   String
  accountId       String
  lineNumber      Int      // Order of entry in transaction

  // Amounts (always positive, indicated by type)
  debit           Decimal  @default(0) @db.Decimal(15, 2)
  credit          Decimal  @default(0) @db.Decimal(15, 2)

  // Details
  description     String?
  memo            String?

  // Dimensions (for cost accounting)
  department      String?
  project         String?
  costCenter      String?

  // Related Entities
  customerId      String?
  vendorId        String?

  // Metadata
  metadata        Json?
  createdAt       DateTime @default(now())

  // Relations
  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  account         Account  @relation(fields: [accountId], references: [id])

  @@index([transactionId])
  @@index([accountId])
  @@index([department])
  @@index([project])
  @@map("journal_entries")
}

model Customer {
  id              String   @id @default(cuid())
  companyId       String

  // Customer Details
  customerNumber  String   // Unique customer number
  name            String
  displayName     String
  email           String?
  phone           String?

  // Address
  billingAddress  Json?
  shippingAddress Json?

  // Financial
  balance         Decimal  @default(0) @db.Decimal(15, 2)
  creditLimit     Decimal  @default(0) @db.Decimal(15, 2)
  paymentTerms    String?  // e.g., "Net 30"

  // Tax
  taxId           String?
  isTaxExempt     Boolean  @default(false)

  // Status
  status          String   @default("ACTIVE")

  // Metadata
  notes           String?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@unique([companyId, customerNumber])
  @@index([companyId])
  @@index([email])
  @@map("customers")
}

model Vendor {
  id              String   @id @default(cuid())
  companyId       String

  // Vendor Details
  vendorNumber    String
  name            String
  displayName     String
  email           String?
  phone           String?

  // Address
  address         Json?

  // Financial
  balance         Decimal  @default(0) @db.Decimal(15, 2)
  paymentTerms    String?

  // Tax
  taxId           String?

  // Banking
  bankAccount     Json?    // Bank account details

  // Status
  status          String   @default("ACTIVE")

  // Metadata
  notes           String?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  company         Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  transactions    Transaction[]

  @@unique([companyId, vendorNumber])
  @@index([companyId])
  @@index([email])
  @@map("vendors")
}

// ==================== AGENT MANAGEMENT (EXISTING) ====================

model Agent {
  id              String   @id @default(cuid())
  organizationId  String
  creatorId       String
  ownerId         String

  // Basic Info
  name            String
  type            AgentType @default(CUSTOM)
  description     String?
  avatar          String?
  category        String?
  status          AgentStatus @default(DRAFT)

  // AI Configuration
  model           String   @default("gpt-4")
  systemPrompt    String
  temperature     Float    @default(0.7)
  maxTokens       Int      @default(4000)
  topP            Float    @default(1.0)
  frequencyPenalty Float   @default(0.0)
  presencePenalty Float    @default(0.0)

  // Capabilities
  capabilities    String[] @default([])
  tools           Json?
  integrations    Json?

  // Monetization
  pricing         Json?
  isPublic        Boolean  @default(false)
  isMarketplace   Boolean  @default(false)

  // Performance
  usageCount      Int      @default(0)
  successRate     Float    @default(100.0)
  avgResponseTime Float    @default(0)
  rating          Float    @default(0)
  reviewCount     Int      @default(0)

  // Metadata
  tags            String[] @default([])
  version         String   @default("1.0.0")
  isActive        Boolean  @default(true)

  // Timestamps
  lastUsedAt      DateTime?
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator         User @relation("AgentCreator", fields: [creatorId], references: [id])
  owner           User @relation("AgentOwner", fields: [ownerId], references: [id])
  interactions    AgentInteraction[]
  workflows       AgentWorkflow[]
  templates       AgentTemplate[]
  swarmMembers    SwarmMember[]

  @@index([organizationId, status])
  @@index([isPublic, category])
  @@index([creatorId])
  @@map("agents")
}

model AgentInteraction {
  id             String   @id @default(cuid())
  organizationId String
  agentId        String
  sessionId      String?
  userId         String?

  // Interaction Details
  type           InteractionType @default(CHAT)
  input          Json
  output         Json?
  context        Json?

  // Performance Metrics
  tokens         Json?
  latency        Int?
  cost           Float?

  // Status & Error
  status         InteractionStatus @default(PENDING)
  errorMessage   String?
  retryCount     Int      @default(0)

  // Metadata
  userAgent      String?
  ipAddress      String?
  metadata       Json?

  // Timestamps
  startedAt      DateTime @default(now())
  completedAt    DateTime?

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  agent          Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@index([organizationId, agentId])
  @@index([startedAt])
  @@index([status])
  @@map("agent_interactions")
}

model AgentWorkflow {
  id              String   @id @default(cuid())
  organizationId  String
  creatorId       String

  // Basic Info
  name            String
  description     String?
  category        String?
  status          WorkflowStatus @default(DRAFT)

  // Workflow Definition
  definition      Json
  version         String   @default("1.0.0")

  // Execution Settings
  triggerType     TriggerType @default(MANUAL)
  triggerConfig   Json?
  schedule        String?

  // Performance
  executionCount  Int      @default(0)
  successRate     Float    @default(100.0)
  avgDuration     Int      @default(0)

  // Publishing
  isPublic        Boolean  @default(false)
  tags            String[] @default([])

  // Timestamps
  lastExecutedAt  DateTime?
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator         User @relation("WorkflowCreator", fields: [creatorId], references: [id])
  executions      WorkflowExecution[]
  agents          Agent[]
  templates       WorkflowTemplate[]

  @@index([organizationId, status])
  @@index([creatorId])
  @@map("agent_workflows")
}

model WorkflowExecution {
  id          String   @id @default(cuid())
  workflowId  String
  triggeredBy String?

  // Execution
  status      ExecutionStatus @default(PENDING)
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?

  // Progress
  currentNode   String?
  completedNodes String[] @default([])

  // Input/Output
  input         Json?
  output        Json?
  variables     Json?

  // Error
  error         String?
  failedNode    String?

  // Relations
  workflow      AgentWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId, status])
  @@map("workflow_executions")
}

model AgentSwarm {
  id              String   @id @default(cuid())
  organizationId  String
  creatorId       String

  // Basic Info
  name            String
  description     String?
  type            SwarmType @default(SEQUENTIAL)
  status          AgentStatus @default(DRAFT)

  // Configuration
  configuration   Json?
  executionOrder  Json?

  // Members
  members         SwarmMember[]

  // Performance
  executionCount  Int      @default(0)
  successRate     Float    @default(100.0)
  avgDuration     Int      @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastExecutedAt  DateTime?

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator         User         @relation(fields: [creatorId], references: [id])

  @@map("agent_swarms")
}

model SwarmMember {
  id              String   @id @default(cuid())
  swarmId         String
  agentId         String

  // Member Configuration
  role            SwarmRole @default(WORKER)
  order           Int       @default(0)
  isRequired      Boolean   @default(true)

  // Configuration
  configuration   Json?

  // Performance
  executionCount  Int       @default(0)
  successCount    Int       @default(0)
  errorCount      Int       @default(0)
  avgDuration     Int       @default(0)

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  lastExecutedAt  DateTime?

  // Relations
  swarm           AgentSwarm @relation(fields: [swarmId], references: [id], onDelete: Cascade)
  agent           Agent      @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([swarmId, agentId])
  @@map("swarm_members")
}

// ==================== TEMPLATES & MARKETPLACE ====================

model AgentTemplate {
  id              String   @id @default(cuid())
  agentId         String?
  organizationId  String

  // Template Info
  name            String
  category        String
  description     String
  icon            String?

  // Configuration Template
  configTemplate  Json
  requirements    Json?

  // Marketplace
  isPublic        Boolean  @default(false)
  isCertified     Boolean  @default(false)
  price           Float    @default(0)

  // Usage
  installCount    Int      @default(0)
  rating          Float    @default(0)
  reviewCount     Int      @default(0)

  // Metadata
  tags            String[] @default([])
  version         String   @default("1.0.0")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  agent           Agent? @relation(fields: [agentId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([isPublic, category])
  @@map("agent_templates")
}

model WorkflowTemplate {
  id              String   @id @default(cuid())
  organizationId  String
  workflowId      String?

  // Template Info
  name            String
  category        String
  description     String

  // Template Data
  template        Json

  // Marketplace
  isPublic        Boolean  @default(false)
  price           Float    @default(0)

  // Usage
  useCount        Int      @default(0)
  rating          Float    @default(0)

  // Metadata
  tags            String[] @default([])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  workflow        AgentWorkflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)

  @@map("workflow_templates")
}

// ==================== SUBSCRIPTION & BILLING ====================

model Subscription {
  id              String   @id @default(cuid())
  organizationId  String
  paymentGatewaySubscriptionId String @unique

  // Subscription Details
  status          SubscriptionStatus
  planType        PlanType
  billingCycle    BillingCycle
  currentPeriodStart DateTime
  currentPeriodEnd DateTime

  // Pricing
  amount          Float
  currency        String @default("INR")
  taxAmount       Float?
  discountAmount  Float? @default(0)
  discountCode    String?

  // Usage Limits
  userLimit       Int
  agentLimit      Int
  workflowLimit   Int
  apiCallLimit    Int

  // Payment Retry & Dunning (NEW)
  failedPaymentCount Int @default(0)
  lastBillingDate    DateTime?
  nextBillingDate    DateTime?
  retryAt            DateTime?

  // Status
  cancelAtPeriodEnd Boolean @default(false)
  canceledAt      DateTime?
  trialEnd        DateTime?

  // Metadata
  metadata        Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices        Invoice[]
  payments        Payment[]

  @@index([organizationId])
  @@index([status])
  @@index([nextBillingDate])
  @@map("subscriptions")
}

model Invoice {
  id              String   @id @default(cuid())
  organizationId  String
  subscriptionId  String?

  // Invoice Details
  invoiceNumber   String   @unique
  status          InvoiceStatus
  amount          Float
  currency        String   @default("INR")
  taxAmount       Float?
  totalAmount     Float

  // Billing
  billingPeriodStart DateTime?
  billingPeriodEnd   DateTime?
  dueDate         DateTime
  paidAt          DateTime?

  // Payment Gateway Integration
  paymentGatewayInvoiceId String?  @unique
  paymentGatewayChargeId  String?
  paymentGateway          String   @default("razorpay")

  // Payment Retry Logic (NEW)
  attemptCount    Int      @default(0)
  lastAttemptAt   DateTime?
  nextAttemptAt   DateTime?
  failureReason   String?

  // Refund Tracking (NEW)
  refundedAmount  Float?   @default(0)
  refundedAt      DateTime?
  refundReason    String?

  // Invoice URLs (NEW)
  hostedInvoiceUrl String?
  invoicePdf      String?

  // Line Items (NEW)
  lineItems       Json?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  payments        Payment[]

  @@index([organizationId])
  @@index([status])
  @@index([nextAttemptAt])
  @@map("invoices")
}

// NEW: Payment Transaction Model
model Payment {
  id              String   @id @default(cuid())
  organizationId  String
  subscriptionId  String?
  invoiceId       String?

  // Payment Details
  amount          Float
  currency        String   @default("INR")
  status          PaymentStatus
  paymentMethod   String?  // card, upi, netbanking, wallet

  // Gateway Integration
  paymentGateway      String @default("razorpay")
  gatewayPaymentId    String @unique
  gatewayOrderId      String?
  gatewayCustomerId   String?

  // Payment Method Details
  cardLast4       String?
  cardBrand       String?
  upiId           String?
  bankName        String?

  // Status Tracking
  capturedAt      DateTime?
  failedAt        DateTime?
  refundedAt      DateTime?
  failureReason   String?
  failureCode     String?

  // Metadata
  metadata        Json?
  description     String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription    Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  invoice         Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([status])
  @@index([gatewayPaymentId])
  @@map("payments")
}

// NEW: Webhook Event Logging
model WebhookEvent {
  id              String   @id @default(cuid())

  // Event Details
  source          String   // razorpay, stripe, etc
  eventType       String   // payment.captured, subscription.created
  eventId         String?  @unique // External event ID

  // Payload
  payload         Json
  headers         Json?

  // Processing
  processed       Boolean  @default(false)
  processedAt     DateTime?
  processingError String?
  retryCount      Int      @default(0)

  // Metadata
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([source, eventType])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events")
}

// ==================== API KEYS & WEBHOOKS ====================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  keyHash        String   @unique
  keyPreview     String

  // Permissions & Scope
  permissions    Json     @default("[]")
  rateLimit      Int      @default(1000)
  ipWhitelist    String[] @default([])

  // Usage
  lastUsedAt     DateTime?
  usageCount     Int      @default(0)
  isActive       Boolean  @default(true)

  // Metadata
  expiresAt      DateTime?
  createdAt      DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("api_keys")
}

model Webhook {
  id             String   @id @default(cuid())
  organizationId String

  // Webhook Details
  name           String
  url            String
  events         String[]
  secret         String?

  // Status & Performance
  isActive       Boolean  @default(true)
  successCount   Int      @default(0)
  failureCount   Int      @default(0)
  lastTriggeredAt DateTime?
  lastStatus     Int?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("webhooks")
}

// ==================== AUDIT & MONITORING ====================

model AuditLog {
  id             String   @id @default(cuid())
  organizationId String?
  userId         String?
  adminId        String?
  companyId      String?  // NEW: Track company-specific actions

  // Action Details
  action         String
  eventType      String?  // e.g., "LOGIN_SUCCESS", "PERMISSION_DENIED"
  severity       String?  // e.g., "INFO", "WARNING", "ERROR", "CRITICAL"
  resourceType   String
  resourceId     String?
  oldValues      Json?
  newValues      Json?
  details        Json?    // Additional event-specific details

  // Context
  ipAddress      String?
  userAgent      String?
  metadata       Json?

  // Timestamp
  createdAt      DateTime @default(now())

  // Relations
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User? @relation(fields: [userId], references: [id], onDelete: SetNull)
  admin          PlatformAdmin? @relation(fields: [adminId], references: [id], onDelete: SetNull)

  @@index([organizationId, action])
  @@index([companyId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model UsageMetric {
  id             String   @id @default(cuid())
  organizationId String
  metricType     String
  metricName     String
  value          Float
  unit           String

  // Dimensions
  dimensions     Json?

  // Time
  recordedAt     DateTime @default(now())
  periodStart    DateTime
  periodEnd      DateTime

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, metricType])
  @@index([recordedAt])
  @@map("usage_metrics")
}

model Notification {
  id             String   @id @default(cuid())
  organizationId String
  userId         String?

  // Notification Details
  type           NotificationType
  title          String
  message        String
  actionUrl      String?

  // Status
  isRead         Boolean  @default(false)
  readAt         DateTime?

  // Metadata
  metadata       Json?
  expiresAt      DateTime?
  createdAt      DateTime @default(now())

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, isRead])
  @@map("notifications")
}

// ==================== ENUMS ====================

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  SUPPORT
  VIEWER
}

enum PlanType {
  TRIAL
  FREE
  STARTER
  GROWTH
  SCALE
  ENTERPRISE
}

enum BillingCycle {
  MONTHLY
  QUARTERLY
  YEARLY
}

enum OrgStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  DELINQUENT
  CANCELLED
  BANNED
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
  LOCKED
}

enum UserRole {
  OWNER
  ADMIN
  DEVELOPER
  ANALYST
  MEMBER
  VIEWER
}

enum SubdomainStatus {
  PENDING
  CONFIGURING
  ACTIVE
  FAILED
  SUSPENDED
  DELETED
}

enum SSLStatus {
  PENDING
  ACTIVE
  EXPIRED
  FAILED
  RENEWING
}

enum HealthStatus {
  HEALTHY
  DEGRADED
  UNHEALTHY
  UNKNOWN
}

enum OAuthProvider {
  GOOGLE
  GITHUB
  LINKEDIN
  MICROSOFT
  FACEBOOK
  TWITTER
  APPLE
  CUSTOM
}

enum SSOProvider {
  GOOGLE_WORKSPACE
  MICROSOFT_365
  OKTA
  AUTH0
  SAML
  CUSTOM
}

enum SessionType {
  WEB
  MOBILE
  API
  ADMIN
  SYSTEM
}

enum LoginMethod {
  PASSWORD
  GOOGLE
  GITHUB
  LINKEDIN
  MICROSOFT
  FACEBOOK
  SSO
  API_KEY
  MAGIC_LINK
}

enum AgentStatus {
  DRAFT
  TESTING
  READY
  ACTIVE
  PAUSED
  RUNNING
  ERROR
  MAINTENANCE
  DEPRECATED
  ARCHIVED
  DELETED
}

enum InteractionType {
  CHAT
  COMPLETION
  FUNCTION_CALL
  WORKFLOW
}

enum InteractionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

enum TriggerType {
  MANUAL
  SCHEDULED
  WEBHOOK
  EVENT
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELLED
  UNPAID
  TRIALING
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  CANCELLED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum NotificationType {
  INFO
  WARNING
  ERROR
  SUCCESS
  BILLING
  SYSTEM
}

enum AgentType {
  LEAD_GENERATOR
  EMAIL_MARKETER
  SOCIAL_MEDIA
  CONTENT_CREATOR
  ANALYTICS
  CUSTOMER_SERVICE
  SALES
  SEO_OPTIMIZER
  CONVERSATIONAL
  TASK_AUTOMATION
  DATA_PROCESSOR
  INTEGRATION
  EMAIL_MARKETING
  WORKFLOW_AUTOMATION
  DATA_PROCESSING
  INTEGRATION_AGENT
  MONITORING_AGENT
  RESEARCH_AGENT
  CUSTOM
}

enum SwarmType {
  SEQUENTIAL
  PARALLEL
  HIERARCHICAL
  COLLABORATIVE
}

enum SwarmRole {
  LEADER
  WORKER
  COORDINATOR
  SPECIALIST
}

// ==================== ACCOUNTING ENUMS ====================

enum CompanyStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  ARCHIVED
}

enum AccountingMethod {
  ACCRUAL
  CASH
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

enum NormalBalance {
  DEBIT
  CREDIT
}

enum TransactionType {
  JOURNAL_ENTRY
  INVOICE
  BILL
  PAYMENT
  RECEIPT
  ADJUSTMENT
  TRANSFER
  OPENING_BALANCE
  CLOSING_ENTRY
}

enum TransactionStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  POSTED
  VOID
  REVERSED
}
